apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: netbox-dev

namePrefix: dev-

commonLabels:
  environment: dev

resources:
  - ../../base/postgres
  - ../../base/redis
  - ../../base/netbox
  - plugin-requirements.yaml
  - plugins-config.yaml

patches:
  # Reduce resource limits for dev environment
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "512Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "500m"
    target:
      kind: Deployment
      name: netbox

  # Update route host and service for dev
  - patch: |-
      - op: add
        path: /spec/host
        value: netbox-dev.apps.rhocp-cluster.presidiolab.local
      - op: replace
        path: /spec/to/name
        value: dev-netbox
    target:
      kind: Route
      name: netbox

  # Add health probes for netbox container
  - patch: |-
      - op: add
        path: /spec/template/spec/containers/0/startupProbe
        value:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 90
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 120
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          tcpSocket:
            port: 8080
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          tcpSocket:
            port: 8080
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
    target:
      kind: Deployment
      name: netbox

  # Mount plugin requirements file for both init and main containers
  - patch: |-
      - op: add
        path: /spec/template/spec/volumes/-
        value:
          name: plugin-requirements
          configMap:
            name: dev-netbox-plugin-requirements
      - op: add
        path: /spec/template/spec/volumes/-
        value:
          name: plugins-config
          configMap:
            name: dev-netbox-plugins-config
      - op: add
        path: /spec/template/spec/initContainers/0/volumeMounts/-
        value:
          name: plugin-requirements
          mountPath: /opt/netbox/local_requirements.txt
          subPath: local_requirements.txt
      - op: add
        path: /spec/template/spec/initContainers/0/volumeMounts/-
        value:
          name: plugins-config
          mountPath: /etc/netbox/config/plugins.py
          subPath: plugins.py
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          name: plugin-requirements
          mountPath: /opt/netbox/local_requirements.txt
          subPath: local_requirements.txt
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          name: plugins-config
          mountPath: /etc/netbox/config/plugins.py
          subPath: plugins.py
    target:
      kind: Deployment
      name: netbox

configMapGenerator:
  - name: netbox-config
    behavior: merge
    literals:
      - ALLOWED_HOSTS=netbox-dev.apps.rhocp-cluster.presidiolab.local dev-netbox.netbox-dev.svc.cluster.local *
      - DB_HOST=dev-postgres
      - REDIS_HOST=dev-redis
      - REDIS_CACHE_HOST=dev-redis
      - DEBUG=true
